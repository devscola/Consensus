<link rel="import" href="/web_components/infrastructure/polymer.html">

<dom-module id="proposal-circle">
	<template>
		<style>
			#circle.show {
				display: block;
			}

			#circle.hide {
				display: none;
			}

		</style>
		<div id="circle" class$="{{circleVisibility}}">
			<div id="user-selection" class="panel-body">
				Create your circle
				<ul id="users" class="list-group"></ul>
				<button id="proposal-finish" disabled$="{{buttonDisabled}}" on-click="closeCircle" class="btn btn-default">Finish</button>
			</div>
		</div>

	</template>
	<script>

		Polymer({
			is: 'proposal-circle',

			ready: function(){
				this.users = document.getElementById('users');
			},

			properties: {
				visible: {
					type: Boolean,
					reflectToAttribute: true,
					observer: 'toggleVisibility'
				},

				circleVisibility: {
					type: String,
					value: 'hide'
				},

				proposal: {
					type: Object,
					reflectToAttribute: true,
					observer: 'renderUsersList'
				},

				usersList: {
					type: Array,
					value: []
				},

				buttonDisabled: {
					type: Boolean,
					value: true
				}

			},

			closeCircle: function(){
				this.visible = false;
				this.emptyCircle();
			},

			emptyCircle: function(){
			    this.users.innerHTML = '';
			},

			renderUsersList: function(){
				this.emptyCircle();
				this.usersList.forEach( function(username) {
					var listItem = document.createElement('li');
					listItem.className = 'user list-group-item';

		            this.selectUser(username, listItem);

		            listItem.append(document.createTextNode(' ' + username));
		            this.users.append(listItem);

	        	}.bind(this));

			},

			selectUser: function(username, element) {
				if (this.proposal.circle.includes(username)) {
					checkSymbol = this.createCheckSymbol(username);
					element.append(checkSymbol);
				} else {
					button = this.createButton(username);
					element.append(button);
				}
			},

			createCheckSymbol: function(username) {
				var checkSymbol = document.createElement('span');
				checkSymbol.className = 'glyphicon glyphicon-check';
				checkSymbol.ariaHidden = 'true';
				checkSymbol.id = username + '-checked';
				return checkSymbol;
			},

			createButton: function(username) {
				button = this.createAddToCircleButton(username);
				this.addUserEvent(button);
				return button;
			},

			addUserEvent: function(button) {
		        button.addEventListener('click', function(){
		            this.addUserToCircle(button.id);
		        }.bind(this));
		    },

		    addUserToCircle: function(username) {
			    this.buttonDisabled = false;
		        var circleData = {
		            username: username,
		            id: this.proposal.id
		        };
		        this.fire('proposalUserAdd', circleData);
		    },

		    createAddToCircleButton: function(username) {
		        var iconButton = document.createElement('span');
		        iconButton.className = 'glyphicon glyphicon-unchecked';
		        iconButton.ariaHidden = 'true';

		        var button = document.createElement('button');
		        button.appendChild(iconButton);
		        button.className = 'add-button';
		        button.id = username;

		        return button;
		    },

			toggleVisibility: function(){
				if (this.visible) {
					this.circleVisibility = 'show';
				} else {
					this.circleVisibility = 'hide';
				}
			}



		});
	</script>
</dom-module>
